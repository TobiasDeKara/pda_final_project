---
title: "paper_replication"
output: pdf_document
---


TODO: classify counties as highly restrictive or not
    - option 1: we can use the summary data that Alice linked to
    (https://www.guttmacher.org/article/2019/08/state-abortion-policy-landscape-hostile-supportive)
    - option 2: dig through the detailed legislation data and use the 3/4 types classification they did in the paper (http://lawatlas.org/datasets/abortion-laws)
    I'd say let's start with the summary data, and we do the extra work to make a more faithful replication later if we have time at the end.
    
TODO: model the propensity weights
    - If I understand this right, we're modeling the propensity for a county to be located in a highly restrictive state.  Is that right?  So we want an estimated probability of a binary outcome, so we want logistic regression. Is that right?



```{r, echo=FALSE, message=FALSE, warning=FALSE}
#load packages
options(tidyverse.quiet=TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(geosphere)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#load in data
providers <- read.csv("provider_list_geo.csv")
countycentroids <- read.csv("county_pop_centroids.csv")
countydem <- read.csv("county_demographics.csv")
abortions <- read.csv("cleanedabortiondata.csv")
restrictions <- read.csv("state_restrictions2010.csv")
```

```{r}
########### calculate abortion rates in 2010 ###########
abortions2010 <- abortions %>% dplyr::select(state, county, X2010)

# clean countydem data to make counties and states match abortion count data 
countydem <- read.csv("county_demographics.csv")

library(stringr)
for (i in 1:nrow(countydem)) {
  countydem$state[i] <- unlist(strsplit(countydem$NAME[i], ", "))[length(unlist(strsplit(countydem$NAME[i], ", ")))]
}

countydem$county <- gsub(countydem$NAME, pattern = ", [[:print:]]*$", replacement = "")
countydem$county <- gsub(countydem$county, pattern = " County", replacement = "")

countydem <- countydem %>% filter(countydem$state %in% state.name)

for (i in 1:nrow(countydem)) {
  countydem$state.abb[i] <- state.abb[which(state.name == countydem$state[i])]
}

abortions2010$county <- gsub(abortions2010$county, pattern = "[()]", replacement = "")

abortions2010$county <- gsub(abortions2010$county, pattern = "ind. city", replacement = "city")

abortions2010$county <- gsub(abortions2010$county, pattern = "Saint", replacement = "St.")

abortions2010$county <- gsub(abortions2010$county, pattern = "Dekalb", replacement = "DeKalb")

abortions2010$county <- gsub(abortions2010$county, pattern = "Desoto", replacement = "DeSoto")

abortions2010$county <- gsub(abortions2010$county, pattern = "Miami Dade", replacement = "Miami-Dade")

abortions2010$county <- gsub(abortions2010$county, pattern = "Hawai'i", replacement = "Hawaii")

abortions2010$county <- gsub(abortions2010$county, pattern = "Kaua'i", replacement = "Kauai")

abortions2010$county <- gsub(abortions2010$county, pattern = "City", replacement = "city")

countydem$county <- gsub(countydem$county, pattern = "City", replacement = "city")

abortions2010$county <- gsub(abortions2010$county, pattern = "Lac Qui Parle", replacement = "Lac qui Parle")

abortions2010$county <- gsub(abortions2010$county, pattern = "St.e Genevieve", replacement = "Ste. Genevieve")

abortions2010$county <- gsub(abortions2010$county, pattern = "Shannon/Oglala Lakota", replacement = "Oglala Lakota")

abortions2010$county <- gsub(abortions2010$county, pattern = "Lamoure", replacement = "LaMoure")


for (i in 1:nrow(abortions2010)) {
  if (length(countydem$Women[countydem$state.abb == abortions2010$state[i] & countydem$county == abortions2010$county[i]]) == 0) {
    abortions2010$Women[i] <- NA
  }
  else {
    abortions2010$Women[i] <- countydem$Women[countydem$state.abb == abortions2010$state[i] & countydem$county == abortions2010$county[i]]
  }
}

#fix NA values
abortions2010$X2010 <- na_if(abortions2010$X2010, "?")
abortions2010$X2010 <- na_if(abortions2010$X2010, "")
abortions2010$X2010 <- as.numeric(abortions2010$X2010)

abortions2010 <- abortions2010 %>% filter(!(county %in% c("NONRESIDENTS", "PROTECTED", "OTHER STATES", "OTHER COUNTRIES", "NON-RESIDENTS", "OTHER", "NEVADA PROTECTED", "NEVADA UNSPECIFIED", "NEBRASKA PROTECTED", "county", "MARYLAND", "St. Louis County")))

abortions2010missingwomen <- abortions2010[is.na(abortions2010$Women), ]

#make rates
abortions2010 <- abortions2010 %>% mutate(rate = X2010/Women)

countypres <- read.csv("countypres.csv")
countypresdem2008 <- countypres %>% filter(party == "DEMOCRAT" & year == 2008)
countypresdem2008$county_name <- str_to_title(countypresdem2008$county_name)
countypresdem2008$county_name[!(countypresdem2008$county_name %in% countydem$county)]

countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = "City", replacement = "city")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = "Dekalb", replacement = "DeKalb")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = "Desoto", replacement = "DeSoto")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = "Lac Qui Parle", replacement = "Lac qui Parle")

countypresdem2008 <- countypresdem2008 %>% mutate(percentdem2008 = candidatevotes/totalvotes) 
names(countypresdem2008)
countypresdem2008 <- countypresdem2008 %>% rename(state.abb = state_po, county = county_name) %>% dplyr::select(state.abb, county, percentdem2008)

countydem <- left_join(countydem, countypresdem2008, by = c("state.abb", "county"))
```

```{r}
# calculate distances from county centroids to closest provider location

for (i in 1:nrow(countycentroids)) {
  lat <- countycentroids$LATITUDE[i]
  long <- countycentroids$LONGITUDE[i]
  dists <- distHaversine(cbind(long, lat), cbind(providers$Lon, providers$Lat))
  countycentroids$distancetoprovider[i] <- min(dists)
}

```


\newpage

## Sources 

Data on the county population centroids came from the United States Census Bureau.
Available at https://www.census.gov/geographies/reference-files/time-series/geo/centers-population.html Accessed 12/11/21.

Data on the county-level voting totals came from the Harvard Dataverse.
Available at https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VOQCHQ. Accessed 12/13/21. 


## Code Appendix
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
