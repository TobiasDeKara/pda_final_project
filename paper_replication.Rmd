---
title: "paper_replication"
output: pdf_document
---
REPLICATION:
TODO: averages of averages for table 2
TODO: reload countydem file with correct college grad pct.
TODO: the paper says "all models included state and year fixed effects and standard errors adjusted for state-level clustering" -> does this mean we need to include states as a variable in our model?
-- No, they did that because they were doing the longitudinal analysis, so like abortion rates in a given state for one year are not independent of the next, so they're accounting for that.
TODO: the paper says "We addressed data gaps in demographic variables by using the estimate from the nearest year for which an estimate was available", so we need to include this methodology
TODO: bias analysis as done in the paper, comparing Guttmacher Census State Data to our State Data
TODO: run the models without the distance variable as well as with the distance variable as the outcome, as done in the paper
TODO: write up everything: we need to follow the format of the original paper <- Toby
TODO: find abortion data used by Brown et al. to compare in discussion <- Toby

EXTENSION:
TODO: write literature review and describe motivation for extension
TODO: rerun extension on state level
TODO: decide whether to rescore the high vs. low restriction variable as a factor or an integer (currently coded as the latter)
TODO: add in rural vs urban variable
TODO: look at Hawkins et al paper linked in the original paper to see what mortality data they used. consider using mortality data by state.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#load packages
options(tidyverse.quiet=TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(geosphere)
library(stringr)
library(kableExtra)
library(table1)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#load in relevant data
providers <- read.csv("provider_list_geo.csv")
countycentroids <- read.csv("county_pop_centroids.csv")
countydem <- read.csv("county_demographics.csv")
abortions <- read.csv("cleanedabortiondata.csv")
restrictions <- read.csv("state_restrictions2010.csv")
countypres <- read.csv("countypres.csv")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
########### clean county dem data ###########
countydem <- read.csv("county_demographics.csv")

for (i in 1:nrow(countydem)) {
  countydem$state[i] <- unlist(strsplit(countydem$NAME[i], ", "))[length(unlist(strsplit(countydem$NAME[i], ", ")))]
}

countydem$county <- gsub(countydem$NAME, pattern = ", [[:print:]]*$", replacement = "")
countydem$county <- gsub(countydem$county, pattern = " County", replacement = "")

countydem <- countydem %>% filter(countydem$state %in% state.name)

for (i in 1:nrow(countydem)) {
  countydem$state.abb[i] <- state.abb[which(state.name == countydem$state[i])]
}

countydem$county <- str_to_title(countydem$county)
countydem$county <- gsub(countydem$county, pattern = "DoÃ±a Ana", replacement = "Dona Ana")

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
########### calculate abortion rates in 2010 ###########

#filter abortion rate data to only 2010
abortions2010 <- abortions %>% dplyr::select(state, county, X2010)

# length(unique(abortions2010$state)) #only 42 states in abortion data

#look at percent missing abortion counts by state
# aggregate(X2010 ~ state, data = abortions2010, function(x) {sum(!(is.na(x)))/length(x)}, na.action = NULL)

# clean abortion data to make counties and states match county dem data
abortions2010$county <- str_to_title(abortions2010$county)
abortions2010$county <- gsub(abortions2010$county, pattern = "[()]", replacement = "")
abortions2010$county <- gsub(abortions2010$county, pattern = "Ind. City", replacement = "City")
abortions2010$county <- gsub(abortions2010$county, pattern = "Saint", replacement = "St.")
abortions2010$county <- gsub(abortions2010$county, pattern = "Miami Dade", replacement = "Miami-Dade")
abortions2010$county <- gsub(abortions2010$county, pattern = "Hawai'i", replacement = "Hawaii")
abortions2010$county <- gsub(abortions2010$county, pattern = "Kaua'i", replacement = "Kauai")
abortions2010$county <- gsub(abortions2010$county, pattern = "St.e Genevieve", replacement = "Ste. Genevieve")
abortions2010$county <- gsub(abortions2010$county, pattern = "Shannon/Oglala Lakota", replacement = "Oglala Lakota")

#fix NA values and make abortion counts numeric
abortions2010$X2010 <- na_if(abortions2010$X2010, "?")
abortions2010$X2010 <- na_if(abortions2010$X2010, "")
abortions2010$X2010 <- as.numeric(abortions2010$X2010)

#remove non-counties
abortions2010 <- abortions2010 %>% filter(!(county %in% c("Nonresidents", "Protected", "Other States", "Other Countries", "Non-Residents", "Other", "Nevada Protected", "Nevada Unspecified", "Nebraska Protected", "County", "Maryland")))

#look at counties in abortion data but not countydem data
# abortions2010$county[!(abortions2010$county %in% countydem$county)]
#"St. Louis County", "Bedford City", "Clifton Forge City"

#look at counties in countydem data but not abortion data
# countydem$county[!(countydem$county %in% abortions2010$county)] #many 
# unique(countydem$state.abb[!(countydem$state.abb %in% abortions2010$state)]) #"AK" "CT" "IA" "LA" "MA" "NH" "NM" "WY"

#Add abortion counts to county data
for (i in 1:nrow(countydem)) {
  if (length(abortions2010$X2010[abortions2010$state == countydem$state.abb[i] & abortions2010$county == countydem$county[i]]) == 0) {
    countydem$AbortionCount2010[i] <- NA
  }
  else {
    countydem$AbortionCount2010[i] <- abortions2010$X2010[abortions2010$state == countydem$state.abb[i] & abortions2010$county == countydem$county[i]]
  }
}

#calculate abortion rates
countydem <- countydem %>% mutate(AbortionRate2010 = AbortionCount2010/Women)

#look at percent missing abortion rates by state
# aggregate(AbortionRate2010 ~ state, data = countydem, function(x) {sum(!(is.na(x)))/length(x)}, na.action = NULL)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
########### calculate percent democratic votes by county in in 2008 ###########
countypresdem2008 <- countypres %>% filter(party == "DEMOCRAT" & year == 2008)
countypresdem2008$county_name <- str_to_title(countypresdem2008$county_name)

countydem$county <- gsub(countydem$county, pattern = " Parish", replacement = "")
countydem$county <- gsub(countydem$county, pattern = " City", replacement = "")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = " City", replacement = "")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = "Saint", replacement = "St.")
countypresdem2008$county_name <- gsub(countypresdem2008$county_name, pattern = " County", replacement = "")

missingcounties <- countypresdem2008[!(countypresdem2008$county_name %in% countydem$county), ] #all of AK and a few others (DC, Dona Ana New Mexico, Kansas City Missouri, Maine Uocava Maine, Federal Precinct Rhode Island)

countypresdem2008 <- countypresdem2008 %>% mutate(percentdem2008 = candidatevotes/totalvotes) 
countypresdem2008 <- countypresdem2008 %>% rename(state.abb = state_po, county = county_name) %>% dplyr::select(state.abb, county, percentdem2008)

countydem <- left_join(countydem, countypresdem2008, by = c("state.abb", "county"))

#look at percent missing dem vote by state
# aggregate(percentdem2008 ~ state, data = countydem, function(x) {sum(!(is.na(x)))/length(x)}, na.action = NULL)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
########### calculate distances from county centroids to closest provider location ###########

for (i in 1:nrow(countycentroids)) {
  lat <- countycentroids$LATITUDE[i]
  long <- countycentroids$LONGITUDE[i]
  dists <- distHaversine(cbind(long, lat), cbind(providers$Lon, providers$Lat))
  countycentroids$distancetoprovider[i] <- min(dists)
}

countycentroids <- countycentroids %>% rename(county = COUNAME, state = STNAME)
countycentroids$county <- str_to_title(countycentroids$county)
countycentroids <- countycentroids %>% dplyr::select(county, state, distancetoprovider)
countycentroids <- countycentroids %>% filter(state != "Puerto Rico")
countycentroids$county <- gsub(countycentroids$county, pattern = " City", replacement = "")

missingcounties <- countycentroids[!(countycentroids$county %in% countydem$county), ] #Alaska and DC

countydem <- left_join(countydem, countycentroids, by = c("state", "county"))

#look at percent missing distance by state
# aggregate(distancetoprovider ~ state, data = countydem, function(x) {sum(!(is.na(x)))/length(x)}, na.action = NULL)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#make new variable for high vs. low restrictions
restrictions <- restrictions %>% mutate(totalrestrict = parental_involvement + two_trips + trap + unconstitutional_ban, 
                                        restrictionlevel = case_when(totalrestrict >= 3 ~ "high", 
                                                              totalrestrict < 3 ~ "low"))
# restrictions$state[!(restrictions$state %in% countydem$state)] #none
countydem <- left_join(countydem, restrictions, by = "state")
countydem$restrictionlevel <- factor(countydem$restrictionlevel, levels = c("low", "high"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#look at demographics

countydem <- countydem %>% mutate(inanalysis = case_when(state.abb %in% c("AZ", "DE", "GA", "IL", "IN", "MI", "NY", "NC", "OH", "OK", "OR", "PA", "SC", "TX", "UT", "VT", "WA", "WI") ~ 1, !(state.abb %in% c("AZ", "DE", "GA", "IL", "IN", "MI", "NY", "NC", "OH", "OK", "OR", "PA", "SC", "TX", "UT", "VT", "WA", "WI")) ~ 0))

countydemanalysis <- countydem %>% filter(inanalysis == 1)

table_1 <- countydemanalysis %>% group_by(state) %>% summarize(totalcounties = n())
usedcounties <- aggregate(AbortionRate2010 ~ state, data = countydemanalysis, function(x) {sum(!(is.na(x)))}, na.action = NULL)
table_1 <- left_join(table_1, usedcounties, by = "state")
table_1 %>% mutate(percent = AbortionRate2010/totalcounties) %>% kbl(col.names = c("State", "Total Counties", "Counties with Abortion Data in 2010", "Percent"), caption = "Number of Counties with Abortion Data Included in Analyses by State", digits = 3) %>% kable_styling()

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
##### Table 2 ####

countydem <- countydem %>% mutate(Total = White + Black + Native.American + Asian + Hispanic, White.pct = White/Total, Black.pct = Black/Total, Native.American.pct = Native.American/Total, Asian.pct = Asian/Total, Hispanic.pct = Hispanic/Total, College.Grad.pct = College.Grad/Total)

countydem$inanalysislabel <- factor(countydem$inanalysis, levels = c(1, 0), labels = c("In Analysis", "Not in Analysis"))

label(countydem$Women) = "Women"
label(countydem$White.pct) = "White"
label(countydem$Black.pct) = "Black"
label(countydem$Native.American.pct) = "Native American"
label(countydem$Asian.pct) = "Asian"
label(countydem$Hispanic.pct) = "Hispanic"
label(countydem$Median.Income) = "Median Income"
label(countydem$College.Grad.pct) = "College Graduates"
label(countydem$percentdem2008) = "Vote Democratic"

units(countydem$Women) = "No."
units(countydem$White.pct) = "%"
units(countydem$Black.pct) = "%"
units(countydem$Native.American.pct) = "%"
units(countydem$Asian.pct) = "%"
units(countydem$Hispanic.pct) = "%"
units(countydem$Median.Income) = "$"
units(countydem$College.Grad.pct) = "%"
units(countydem$percentdem2008) = "%"

# The following function is based on 
# "Using the table1 Package to Create HTML Tables of Descriptive Statistics"
# by Benjamin Rich.  Available at:
# https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html#example-a-column-of-p-values
p_value_t_test <- function(x, ...){
    y <- unlist(x[1:2])
    g <- factor(rep(1:length(x[1:2]), times=sapply(x[1:2], length)))
    p <- t.test(y ~ g)$p.value  %>% round(3) 
    c("", sub("<", "<", format.pval(p, digits=3, eps=0.001)))
}

## Table 2 ###
table1(~ Women + White.pct + Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + College.Grad.pct + percentdem2008 | inanalysislabel, 
       data = countydem,
       overall = FALSE,
       extra.col = list(`P-value` = p_value_t_test),
       extra.col.pos = 3,
       footnote = 'P-values are derived by two sample t-tests.',
       caption = "County Data for States Included and Not Included in Analysis"
       )
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=5, fig.align='center'}
#calculate propensity scores
propensitywts <- glm(inanalysis ~ Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + Women + percentdem2008, data=countydem, family=binomial())
# summary(propensitywts)

p.score <- predict(propensitywts, countydem, type = "response")
df <- countydem
df$ps <- p.score

# plot of distribution of propensity scores 
ggplot(df, aes(x = ps, group = inanalysislabel)) + geom_density(aes(fill = inanalysislabel), alpha = 0.2) +
  xlab('Probability of Being in the Analysis') +
  ggtitle('Figure 1: Propensity Score Distribution by Group') +
  scale_fill_discrete('') +
  theme(legend.position = 'bottom', legend.direction = 'vertical') +
  ylab("Density")

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#run models
countydemanalysis <- df %>% filter(inanalysis == 1)

model_no_dist <- lm(AbortionRate2010 ~ restrictionlevel, data = countydemanalysis, weights = ps)
summ_no_dist <- summary(model_no_dist)

model_dist <- lm(AbortionRate2010 ~ restrictionlevel + distancetoprovider + restrictionlevel*distancetoprovider, data = countydemanalysis, weights = ps)
summ_dist <- summary(model_dist)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Model Summaries (Note coefficients are per 1000 women)
table_3 <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2]*1000,
                  "p-value" = c('< 0.001')) %>% 
  kbl(caption = "Change in Abortions per 1000 Women in Model without Distances", 
          digits = 3)
table_3
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
p <- summ_dist$coefficients[4,4] %>% round(3)
table_4 <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2]*1000, model_dist$coefficients[3]*1000,
                           model_dist$coefficients[4]*1000),
                  "p-value" = c('< 0.001', '< 0.001', p)) %>%
  kbl(caption = "Change in Abortions per 1000 Women in Model with Distances")
table_4

###### End of Replication ######
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#### Begin Extension #####
####### add in natality, maternalmortality, and infantdeath data #######
natality <- read.delim("natalitydata.txt")
maternalmortality <- read.delim("maternalmortality.txt")
infantdeath <- read.delim("infantdeathrecords.txt")

infantdeath$County <- gsub(infantdeath$County, pattern = ", [[:print:]]*$", replacement = "")
infantdeath$County <- gsub(infantdeath$County, pattern = " County", replacement = "")
infantdeath$County <- str_to_title(infantdeath$County)
infantdeath$County <- na_if(infantdeath$County, "")
infantdeath <- infantdeath %>% filter(County != "Unidentified Counties")
infantdeath$County <- gsub(infantdeath$County, pattern = " Parish", replacement = "")
infantdeath$County <- gsub(infantdeath$County, pattern = "Borough", replacement = "Municipality")
infantdeath$County <- gsub(infantdeath$County, pattern = " City", replacement = "")
# infantdeath$County[!(infantdeath$County %in% countydem$county)]
infantdeath <- infantdeath %>% rename(state = State, county = County, infantdeathrate = Death.Rate)
infantdeath <- infantdeath %>% dplyr::select(state, county, infantdeathrate)

maternalmortality$County <- gsub(maternalmortality$County, pattern = ", [[:print:]]*$", replacement = "")
maternalmortality$County <- gsub(maternalmortality$County, pattern = " County", replacement = "")
maternalmortality$County <- str_to_title(maternalmortality$County)
maternalmortality$County <- na_if(maternalmortality$County, "")
maternalmortality <- maternalmortality %>% filter(County != "Unidentified Counties")
maternalmortality$County <- gsub(maternalmortality$County, pattern = " Parish", replacement = "")
maternalmortality$County <- gsub(maternalmortality$County, pattern = "Borough", replacement = "Municipality")
maternalmortality$County <- gsub(maternalmortality$County, pattern = " City", replacement = "")
maternalmortality$County <- gsub(maternalmortality$County, pattern = "La Porte", replacement = "Laporte")
maternalmortality$County <- gsub(maternalmortality$County, pattern = "De Kalb", replacement = "Dekalb")
maternalmortality$County <- gsub(maternalmortality$County, pattern = "Mc Kean", replacement = "Mckean")
maternalmortality$County[!(maternalmortality$County %in% countydem$county)] <- gsub(maternalmortality$County[!(maternalmortality$County %in% countydem$county)], pattern = "Municipality", replacement = "Borough")
maternalmortality$County[!(maternalmortality$County %in% countydem$county)] <- gsub(maternalmortality$County[!(maternalmortality$County %in% countydem$county)], pattern = "Borough", replacement = "And Borough")
maternalmortality$County[!(maternalmortality$County %in% countydem$county)] <- gsub(maternalmortality$County[!(maternalmortality$County %in% countydem$county)], pattern = "/", replacement = " ")
maternalmortality$County[!(maternalmortality$County %in% countydem$county)] <- gsub(maternalmortality$County[!(maternalmortality$County %in% countydem$county)], pattern = " Census Area", replacement = "")
maternalmortality$County[!(maternalmortality$County %in% countydem$county)] <- gsub(maternalmortality$County[!(maternalmortality$County %in% countydem$county)], pattern = " And", replacement = "")
# maternalmortality$County[!(maternalmortality$County %in% countydem$county)]

maternalmortality <- maternalmortality %>% rename(state = State, county = County, maternaldeaths = Deaths, maternaldeathrate = Crude.Rate)
maternalmortality <- maternalmortality %>% dplyr::select(state, county, maternaldeathrate)

natality$County <- gsub(natality$County, pattern = ", [[:print:]]*$", replacement = "")
natality$County <- gsub(natality$County, pattern = " County", replacement = "")
natality$County <- str_to_title(natality$County)
natality$County <- na_if(natality$County, "")
natality <- natality %>% filter(County != "Unidentified Counties")
natality$County <- gsub(natality$County, pattern = " Parish", replacement = "")
natality$County <- gsub(natality$County, pattern = "Borough", replacement = "Municipality")
natality$County <- gsub(natality$County, pattern = " City", replacement = "")
natality$County <- gsub(natality$County, pattern = "La Porte", replacement = "Laporte")
# natality$County[!(natality$County %in% countydem$county)]
natality <- natality %>% rename(state = State, county = County)
natality <- natality %>% dplyr::select(state, county, Birth.Rate, Fertility.Rate)

countydem <- left_join(countydem, infantdeath, by = c("state", "county"))
countydem <- left_join(countydem, maternalmortality, by = c("state", "county"))
countydem <- left_join(countydem, natality, by = c("state", "county"))

# sum(is.na(countydem$infantdeathrate)/nrow(countydem))
countydem$maternaldeathrate <- na_if(countydem$maternaldeathrate, "Suppressed")
countydem$maternaldeathrate <- na_if(countydem$maternaldeathrate, "Missing")

# sum(is.na(countydem$maternaldeathrate)/nrow(countydem))
# sum(is.na(countydem$Birth.Rate)/nrow(countydem))

```
## Expansion to Data from All States
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#### recode restriction level and include all counties with abortion data in analysis ####
countyanalysis <- function(varname) {
  countydem <- countydem %>% mutate(hasdata = case_when(is.na(countydem[[varname]]) ~ 0, 
                                                              !(is.na(countydem[[varname]])) ~ 1))
  countydemanalysis <- countydem %>% filter(hasdata == 1)
  summarytable <- countydem %>% group_by(state) %>% summarize(totalcounties = n())
  usedcounties <- aggregate(countydem[[varname]] ~ state, data = countydem, function(x) {sum(!(is.na(x)))}, na.action = NULL)
  summarytable <- left_join(summarytable, usedcounties, by = "state")
  summarytable <- summarytable %>% mutate(percent = summarytable[, 3]/totalcounties) %>% 
    kbl(col.names = c("State", "Total Counties", "Counties with Data in 2010", "Percent"), 
        caption = "Number of Counties with Data Included in Analysis by State") %>% 
    kable_styling()
  
  countydem$hasdatalabel <- factor(countydem$hasdata, levels = c(1, 0), labels = c("Counties in States With Data", "Counties in States Without Data"))

  label(countydem$Women) = "Women"
  label(countydem$White.pct) = "White"
  label(countydem$Black.pct) = "Black"
  label(countydem$Native.American.pct) = "Native American"
  label(countydem$Asian.pct) = "Asian"
  label(countydem$Hispanic.pct) = "Hispanic"
  label(countydem$Median.Income) = "Median Income"
  label(countydem$College.Grad.pct) = "College Graduates"
  label(countydem$percentdem2008) = "Voting for the Democratic candidate in the most recent presidential election"

  units(countydem$Women) = "No."
  units(countydem$White.pct) = "%"
  units(countydem$Black.pct) = "%"
  units(countydem$Native.American.pct) = "%"
  units(countydem$Asian.pct) = "%"
  units(countydem$Hispanic.pct) = "%"
  units(countydem$Median.Income) = "$"
  units(countydem$College.Grad.pct) = "%"
  units(countydem$percentdem2008) = "%"
  
  # p_value_t_test <- function(x, ...){
  #   y <- unlist(x[1:2])
  #   g <- factor(rep(1:length(x[1:2]), times=sapply(x[1:2], length)))
  #   p_value <- t.test(y ~ g)$p.value %>% round(3) %>% as.character()
  #   p_value <- ifelse(p_value == '0', '< 0.001', p_value)
  # }
  # 
  # in_analysis_comp_table <- table1(~ Women + White.pct + Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + College.Grad.pct + percentdem2008 | hasdatalabel, 
  #      data = countydem,
  #      extra.col = list(`P-value` = p_value_t_test),
  #      footnote = 'P-values are derived by two sample t-tests.'
  #      )
  
  #calculate propensity scores
  #include education this time
  propensitywts <- glm(hasdata ~ Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + Women + percentdem2008 + College.Grad.pct, data=countydem, family=binomial())

  p.score <- predict(propensitywts, countydem, type = "response")
  df <- countydem
  df$ps <- p.score
  
  #plot of distribution of propensity scores 
  # p1 <- ggplot(df, aes(x = ps, group = hasdatalabel)) + geom_density(aes(fill = hasdatalabel), alpha = 0.2) +
  # xlab('Probability of Being in the Analysis') +
  # ggtitle('Propensity Score Distribution by Group') +
  # scale_fill_discrete('') +
  # theme(legend.position = 'bottom', legend.direction = 'vertical') +
  # ylab("Density")
  # print(p1)
  
  #run model
  countydemanalysis <- df %>% filter(hasdata == 1)
  model_no_dist <- lm(countydemanalysis[[varname]] ~ totalrestrict, data = countydemanalysis, weights = ps)
  
  model_dist <- lm(countydemanalysis[[varname]] ~ totalrestrict + distancetoprovider + totalrestrict*distancetoprovider, data = countydemanalysis, weights = ps)
  return(list(summary(model_no_dist), summary(model_dist), summarytable))
}


returns <- countyanalysis("AbortionRate2010")
all_state_model_no_dist <- returns[[1]]
all_state_model_dist <- returns[[2]]

# Model Summaries (Note coefficients are per 1000 women)
table_5 <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = all_state_model_no_dist$coefficients[2]*1000,
                  "p-value" = c('< 0.001')) %>% 
  kbl(caption = "All States Data: Change in Abortions per 1000 Women in Model without Distances", 
          digits = 3)
table_5

p <- all_state_model_dist$coefficients[4,4] %>% round(3)
table_6 <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(all_state_model_dist$coefficients[2]*1000, 
                           all_state_model_dist$coefficients[3]*1000,
                           all_state_model_dist$coefficients[4]*1000),
                  "p-value" = c('< 0.001', '< 0.001', p)) %>%
  kbl(caption = "All States Data: Change in Abortions per 1000 Women in Model with Distances")
table_6

all_state_table <- returns[[3]]
# all_state_table # move to appendix?
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
###further clean up maternaldeathrate, infantdeathrate, birthrate, and fertilityrate data ####
countydem$maternaldeathrate <- gsub(countydem$maternaldeathrate, pattern = "[()]", replacement = "")
countydem$maternaldeathrate <- gsub(countydem$maternaldeathrate, pattern = "Unreliable", replacement = "")
countydem$maternaldeathrate <- as.numeric(countydem$maternaldeathrate)
# hist(countydem$maternaldeathrate)

countydem$infantdeathrate <- na_if(countydem$infantdeathrate, "Missing County")
countydem$infantdeathrate <- gsub(countydem$infantdeathrate, pattern = "[()]", replacement = "")
countydem$infantdeathrate <- gsub(countydem$infantdeathrate, pattern = "Unreliable", replacement = "")
countydem$infantdeathrate <- as.numeric(countydem$infantdeathrate)
# hist(countydem$infantdeathrate)

countydem$Birth.Rate <- na_if(countydem$Birth.Rate, "Missing County")
countydem$Birth.Rate <- as.numeric(countydem$Birth.Rate)
# hist(countydem$Birth.Rate)

countydem$Fertility.Rate <- na_if(countydem$Fertility.Rate, "Missing County")
countydem$Fertility.Rate <- as.numeric(countydem$Fertility.Rate)
# hist(countydem$Fertility.Rate)

```

## Extesion to Infant Death Rate, Birth Rate, and Fertility Rate

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#### Large County Function

largecountyanalysis <- function(varname) {
  largecountydem <- countydem %>% filter(Total >= 250000)
  largecountydem <- largecountydem %>% mutate(hasdata = case_when(is.na(largecountydem[[varname]]) ~ 0, 
                                                              !(is.na(largecountydem[[varname]])) ~ 1))
  largecountydemanalysis <- largecountydem %>% filter(hasdata == 1)
  summarytable <- countydem %>% group_by(state) %>% summarize(totalcounties = n())
  usedcounties <- aggregate(largecountydem[[varname]] ~ state, data = largecountydem, function(x) {sum(!(is.na(x)))}, na.action = NULL)
  summarytable <- left_join(summarytable, usedcounties, by = "state")
  # print(summarytable %>% mutate(percent = summarytable[, 3]/totalcounties) %>% kbl(col.names = c("State", "Total Counties", "Counties with Data in 2010", "Percent"), caption = "Table 1. Number of Counties with Data Included in Analysis by State") %>% kable_styling())
  
  largecountydem$hasdatalabel <- factor(largecountydem$hasdata, levels = c(1, 0), labels = c("Counties in States With Data", "Counties in States Without Data"))

  label(largecountydem$Women) = "Women"
  label(largecountydem$White.pct) = "White"
  label(largecountydem$Black.pct) = "Black"
  label(largecountydem$Native.American.pct) = "Native American"
  label(largecountydem$Asian.pct) = "Asian"
  label(largecountydem$Hispanic.pct) = "Hispanic"
  label(largecountydem$Median.Income) = "Median Income"
  label(largecountydem$College.Grad.pct) = "College Graduates"
  label(largecountydem$percentdem2008) = "Voting for the Democratic candidate in the most recent presidential election"

  units(largecountydem$Women) = "No."
  units(largecountydem$White.pct) = "%"
  units(largecountydem$Black.pct) = "%"
  units(largecountydem$Native.American.pct) = "%"
  units(largecountydem$Asian.pct) = "%"
  units(largecountydem$Hispanic.pct) = "%"
  units(largecountydem$Median.Income) = "$"
  units(largecountydem$College.Grad.pct) = "%"
  units(largecountydem$percentdem2008) = "%"
  

  # print(table1(~ Women + White.pct + Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + College.Grad.pct + percentdem2008 | hasdatalabel, 
  #      data = largecountydem,
  #     ))
  
  #calculate propensity scores
  #include education this time
  propensitywts <- glm(hasdata ~ Black.pct + Native.American.pct + Asian.pct + Hispanic.pct + Median.Income + Women + percentdem2008 + College.Grad.pct, data=largecountydem, family=binomial())

  p.score <- predict(propensitywts, largecountydem, type = "response")
  df <- largecountydem
  df$ps <- p.score
  
  #plot of distribution of propensity scores 
  p1 <- ggplot(df, aes(x = ps, group = hasdatalabel)) + geom_density(aes(fill = hasdatalabel), alpha = 0.2) +
  xlab('Probability of Being in the Analysis') +
  ggtitle('Propensity Score Distribution by Group') +
  scale_fill_discrete('') +
  theme(legend.position = 'bottom', legend.direction = 'vertical') +
  ylab("Density")
  # print(p1)
  
  #run model
  largecountydemanalysis <- df %>% filter(hasdata == 1)

  model_no_dist <- lm(largecountydemanalysis[[varname]] ~ totalrestrict, data = largecountydemanalysis, weights = ps)
  
  model_dist <- lm(largecountydemanalysis[[varname]] ~ totalrestrict + distancetoprovider + totalrestrict*distancetoprovider, data = largecountydemanalysis, weights = ps)

  return(list(summary(model_no_dist), summary(model_dist)))
}

returns <- largecountyanalysis("infantdeathrate")
large_county_no_dist <- returns[[1]]
large_county_dist <- returns[[2]]

# Model Summaries
table_7 <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = large_county_no_dist$coefficients[2],
                  "p-value" = c('< 0.001')) %>% 
  kbl(caption = "Large County Data: Change in Infant Death Rate per 1000 **** in Model without Distances", 
          digits = 4)
table_7

p_2 <- large_county_dist$coefficients[3,4] %>% round(3)
p_3 <- large_county_dist$coefficients[4,4] %>% round(3)

table_8 <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(large_county_dist$coefficients[2], 
                           large_county_dist$coefficients[3],
                           large_county_dist$coefficients[4]),
                  "p-value" = c('< 0.001', p_2, p_3)) %>%
  kbl(caption = "Large County Data: Change in Infant Death Rate per 1000 **** in Model with Distances")
table_8


```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# largecountyanalysis("Birth.Rate")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# largecountyanalysis("Fertility.Rate")
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
#add in state level maternaldeathrate, infantdeathrate, birthrate, and fertilityrate data ####

statelevelnatality <- read.delim("statelevelnatality.txt")
statelevelinfantdeaths <- read.delim("statelevelinfantdeaths.txt")
statelevelfetaldeaths <- read.delim("statelevelfetaldeaths.txt")
statelevelmaternalmortality <- read.delim("statelevelmaternalmortality.txt")

statelevelnatality <- statelevelnatality %>% select(State, Birth.Rate, Fertility.Rate)
statelevelinfantdeaths <- statelevelinfantdeaths %>% select(State, Death.Rate)
statelevelfetaldeaths <- statelevelfetaldeaths %>% select(Standard.Residence.States, Percent.of.Total.Deaths) %>% rename(State = Standard.Residence.States, Pct.Fetal.Deaths = Percent.of.Total.Deaths)
statelevelmaternalmortality <- statelevelmaternalmortality %>% select(State, X..of.Total.Deaths) %>% rename(Pct.Maternal.Deaths = X..of.Total.Deaths)

statedem <- countydem %>% group_by(state) %>% summarize(AvgWomen = mean(Women, na.rm = TRUE), AvgWhite.pct = mean(White.pct, na.rm = TRUE), AvgBlack.pct = mean(Black.pct, na.rm = TRUE), AvgNative.American.pct = mean(Native.American.pct, na.rm = TRUE), AvgAsian.pct = mean(Asian.pct, na.rm = TRUE), AvgHispanic.pct = mean(Hispanic.pct, na.rm = TRUE), AvgCollege.Grad.pct = mean(College.Grad.pct, na.rm = TRUE), AvgMedian.Income = mean(Median.Income, na.rm = TRUE), AvgDem2008.pct = mean(percentdem2008, na.rm = TRUE), AvgDistancetoProvider = mean(distancetoprovider, na.rm = TRUE), TotalRestrictions = mean(totalrestrict, na.rm = TRUE), AvgAbortionRate2010 = mean(AbortionRate2010, na.rm = TRUE)) %>% rename(State = state)

statedem <- left_join(statedem, statelevelnatality, by = c("State"))
statedem <- left_join(statedem, statelevelinfantdeaths , by = c("State"))
statedem <- left_join(statedem, statelevelfetaldeaths, by = c("State"))
statedem <- left_join(statedem, statelevelmaternalmortality, by = c("State"))

for (i in 1:ncol(statedem)) {
  statedem[[i]][is.nan(statedem[[i]])] <- NA
}

statedem$Pct.Maternal.Deaths <- na_if(statedem$Pct.Maternal.Deaths, "Suppressed")
statedem$Pct.Maternal.Deaths <- gsub(statedem$Pct.Maternal.Deaths, pattern = "%", replacement = "")
statedem$Pct.Maternal.Deaths <- as.numeric(statedem$Pct.Maternal.Deaths)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
###make function for extended analysis###
stateanalysis <- function(varname) {
  statedem <- statedem %>% mutate(hasdata = case_when(is.na(statedem[[varname]]) ~ 0, 
                                                              !(is.na(statedem[[varname]])) ~ 1))
  statedemanalysis <- statedem %>% filter(hasdata == 1)
  statedem$hasdatalabel <- factor(statedem$hasdata, levels = c(1, 0), labels = c("States With Data", "States Without Data"))

  label(statedem$AvgWomen) = "Average Women"
  label(statedem$AvgWhite.pct) = "Average White"
  label(statedem$AvgBlack.pct) = "Average Black"
  label(statedem$AvgNative.American.pct) = "Average Native American"
  label(statedem$AvgAsian.pct) = "Average Asian"
  label(statedem$AvgHispanic.pct) = "Average Hispanic"
  label(statedem$AvgMedian.Income) = "Average Median Income"
  label(statedem$AvgCollege.Grad.pct) = "Average College Graduates"
  label(statedem$AvgDem2008.pct) = "Democratic Vote"

  units(statedem$AvgWomen) = "No."
  units(statedem$AvgWhite.pct) = "%"
  units(statedem$AvgBlack.pct) = "%"
  units(statedem$AvgNative.American.pct) = "%"
  units(statedem$AvgAsian.pct) = "%"
  units(statedem$AvgHispanic.pct) = "%"
  units(statedem$AvgMedian.Income) = "$"
  units(statedem$AvgCollege.Grad.pct) = "%"
  units(statedem$AvgDem2008.pct) = "%"

  # print(table1(~ AvgWomen + AvgWhite.pct + AvgBlack.pct + AvgNative.American.pct + AvgAsian.pct + AvgHispanic.pct + AvgMedian.Income + AvgCollege.Grad.pct + AvgDem2008.pct | hasdatalabel, 
  #      data = statedem,
  #      extra.col = list(`P-value` = p_value_t_test),
  #      footnote = 'P-values are derived by two sample t-tests.'
  #      ))
  
  #calculate propensity scores
  #include education this time
  propensitywts <- glm(hasdata ~ AvgWhite.pct + AvgBlack.pct + AvgNative.American.pct + AvgAsian.pct + AvgHispanic.pct + AvgMedian.Income + AvgCollege.Grad.pct + AvgDem2008.pct, data=statedem, family=binomial())

  p.score <- predict(propensitywts, statedem, type = "response")
  df <- statedem
  df$ps <- p.score
  
  #plot of distribution of propensity scores 

  # plot1 <- ggplot(df, aes(x = ps, group = hasdatalabel)) + geom_density(aes(fill = hasdatalabel), alpha = 0.2) +
  #   xlab('Probability of Being in the Analysis') +
  #   ggtitle('Propensity Score Distribution by Group') +
  #   scale_fill_discrete('') +
  #   theme(legend.position = 'bottom', legend.direction = 'vertical') +
  #   ylab("Density")
  # print(plot1)

  #run model
  statedemanalysis <- df %>% filter(hasdata == 1)

  model_no_dist <- lm(statedemanalysis[[varname]] ~ TotalRestrictions, weights = ps, data = statedemanalysis)
  
  model_dist <- lm(statedemanalysis[[varname]] ~ TotalRestrictions + AvgDistancetoProvider + TotalRestrictions*AvgDistancetoProvider, data = statedemanalysis, weights = ps)
  
  return(list(summary(model_no_dist), summary(model_dist)))
}

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# returns <- stateanalysis("AvgAbortionRate2010")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
### State Birth Rate
returns <- stateanalysis("Birth.Rate")
model_no_dist <- returns[[1]]
model_dist <- returns[[2]]

p <- model_no_dist$coefficients[2,4] %>% round(3)
# Model Summaries
table_9 <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2],
                  "p-value" = c(p)) %>% 
  kbl(caption = "State Data: Change in Birth Rate Rate per 1000 People in Model without Distances", 
          digits = 4)
table_9

p_1 <- model_dist$coefficients[2,4] %>% round(3)
p_2 <- model_dist$coefficients[3,4] %>% round(3)
p_3 <- model_dist$coefficients[4,4] %>% round(3)

table_10 <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2], 
                           model_dist$coefficients[3],
                           model_dist$coefficients[4]),
                  "p-value" = c(p_1, p_2, p_3)) %>%
  kbl(caption = "State Data: Change in Birth Rate per 1000 People in Model with Distances")
table_10
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
### State Fertility Rate
returns <- stateanalysis("Fertility.Rate")
model_no_dist <- returns[[1]]
model_dist <- returns[[2]]

p <- model_no_dist$coefficients[2,4] %>% round(3)
# Model Summaries
table_no_dist <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2],
                  "p-value" = c(p)) %>% 
  kbl(caption = "State Data: Change in Fertility Rate Rate per 1000 Women in Model without Distances", 
          digits = 4)
table_no_dist

p_1 <- model_dist$coefficients[2,4] %>% round(3)
p_2 <- model_dist$coefficients[3,4] %>% round(3)
p_3 <- model_dist$coefficients[4,4] %>% round(3)

table_dist <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2], 
                           model_dist$coefficients[3],
                           model_dist$coefficients[4]),
                  "p-value" = c(p_1, p_2, p_3)) %>%
  kbl(caption = "State Data: Change in Fertility Rate per 1000 Women in Model with Distances")
table_dist
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
### State  Infant Death Rate
returns <- stateanalysis("Death.Rate")
model_no_dist <- returns[[1]]
model_dist <- returns[[2]]

# p <- model_no_dist$coefficients[2,4] %>% round(3)
# Model Summaries
table_no_dist <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2],
                  "p-value" = '< 0.001') %>% 
  kbl(caption = "State Data: Change in Infant Death Rate Rate per 1000 **** in Model without Distances", 
          digits = 4)
table_no_dist

# p_1 <- model_dist$coefficients[2,4] %>% round(3)
p_2 <- model_dist$coefficients[3,4] %>% round(3)
p_3 <- model_dist$coefficients[4,4] %>% round(3)

table_dist <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2], 
                           model_dist$coefficients[3],
                           model_dist$coefficients[4]),
                  "p-value" = c('< 0.001', p_2, p_3)) %>%
  kbl(caption = "State Data: Change in Infant Death Rate per 1000 **** in Model with Distances")
table_dist
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

### State Fetal Death Percent
returns <- stateanalysis("Pct.Fetal.Deaths")
model_no_dist <- returns[[1]]
model_dist <- returns[[2]]

p <- model_no_dist$coefficients[2,4] %>% round(3)
# Model Summaries
table_no_dist <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2],
                  "p-value" = p) %>% 
  kbl(caption = "State Data: Change in Percent Fetal Deaths in Model without Distances", 
          digits = 4)
table_no_dist

p_1 <- model_dist$coefficients[2,4] %>% round(3)
p_2 <- model_dist$coefficients[3,4] %>% round(3)
p_3 <- model_dist$coefficients[4,4] %>% round(3)

table_dist <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2], 
                           model_dist$coefficients[3],
                           model_dist$coefficients[4]),
                  "p-value" = c(p_1, p_2, p_3)) %>%
  kbl(caption = "State Data: Change in Percent Fetal Deaths in Model with Distances")
table_dist
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
### State Maternal Deaths
returns <- stateanalysis("Pct.Maternal.Deaths")
model_no_dist <- returns[[1]]
model_dist <- returns[[2]]

p <- model_no_dist$coefficients[2,4] %>% round(3)
# Model Summaries
table_no_dist <- tibble(Characteristic = "Highly Restrictive Legislation",
                  Beta = model_no_dist$coefficients[2],
                  "p-value" = p) %>% 
  kbl(caption = "State Data: Change in Maternal Deaths per ***** in Model without Distances", 
          digits = 4)
table_no_dist

p_1 <- model_dist$coefficients[2,4] %>% round(3)
p_2 <- model_dist$coefficients[3,4] %>% round(3)
p_3 <- model_dist$coefficients[4,4] %>% round(3)

table_dist <- tibble(Characteristic = c("Highly Restrictive Legislation", "Distance to Provider",
                                     "Distance/Restriction Interaction"),
                  Beta = c(model_dist$coefficients[2], 
                           model_dist$coefficients[3],
                           model_dist$coefficients[4]),
                  "p-value" = c(p_1, p_2, p_3)) %>%
  kbl(caption = "State Data: Change in Percent Maternal Deaths per **** in Model with Distances")
table_dist
```

\newpage

## Sources 

Data on the county population centroids came from the United States Census Bureau.
Available at https://www.census.gov/geographies/reference-files/time-series/geo/centers-population.html Accessed 12/11/21.

Data on the county-level voting totals came from the Harvard Dataverse.
Available at https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VOQCHQ. Accessed 12/13/21. 


## Code Appendix
```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
